# Release workflow

This document explains how the `Release` GitHub Actions workflow works and how to use it.

- Workflow file: `.github/workflows/release.yml`
- Trigger: **push of any tag matching `v*`** (for example: `v0.1.0`, `v1.2.3`).
- Release notes: **auto-generated by GitHub** from commits & pull requests between tags.

## What the workflow does

The workflow has three jobs:

1. **`build-and-release` (macOS arm64)**
	- Runs on `macos-latest-xlarge`.
	- Builds the binary in release mode with `swift build -c release`.
	- Uploads `.build/release/gitgulf` as an artifact named `gitgulf-macos-arm64`.

2. **`build-linux` (Linux amd64 + arm64)**
	- Runs on `ubuntu-latest`.
	- Uses Docker + QEMU to build for:
		- `linux/amd64`
		- `linux/arm64`
	- Copies the release binary to:
		- `artifacts/gitgulf-linux-amd64`
		- `artifacts/gitgulf-linux-arm64`
	- Uploads each as artifacts `gitgulf-linux-amd64` and `gitgulf-linux-arm64`.

3. **`create-release` (GitHub Release + Homebrew)**
	- Waits for `build-and-release` and `build-linux` to finish.
	- Downloads all artifacts to `./artifacts`.
	- Copies them into `release-assets/` with fixed names:
		- `gitgulf-macos-arm64`
		- `gitgulf-linux-amd64`
		- `gitgulf-linux-arm64`
	- Marks all files in `release-assets/` as executable.
	- Generates `release-assets/checksums.txt` with SHA-256 for all three binaries.
	- Uses `softprops/action-gh-release` to create a GitHub Release for the tag and attach:
		- The three binaries
		- `checksums.txt`
	- Checks out `tychop/homebrew-gitgulf` into `homebrew-gitgulf/`.
	- Extracts the version from the tag (removes leading `v`).
	- Computes the SHA-256 of the macOS binary.
	- Writes/overwrites `homebrew-gitgulf/Formula/gitgulf.rb` to:
		- Point at the GitHub release asset URL for `gitgulf-macos-arm64`.
		- Use the computed SHA-256.
	- Commits and pushes the updated formula back to the `homebrew-gitgulf` repository.

## How to cut a new release

1. Ensure the branch you are releasing from is pushed (typically `main`):

	```bash
	git push
	```

2. Choose a new semantic version and create a tag beginning with `v`:

	```bash
	# Example: releasing 0.2.0
	git tag v0.2.0
	git push origin v0.2.0
	```

3. Monitor the workflow:
	- Go to the repository on GitHub.
	- Open the **Actions** tab.
	- Look for the **Release** workflow run corresponding to your tag.

4. After the workflow succeeds:
	- A new GitHub Release `vX.Y.Z` appears under **Releases** with assets:
		- `gitgulf-macos-arm64`
		- `gitgulf-linux-amd64`
		- `gitgulf-linux-arm64`
		- `checksums.txt`
	- The `tychop/homebrew-gitgulf` tap has a new commit updating `Formula/gitgulf.rb` to that version.

## Requirements / assumptions

- Repository `tychop/homebrew-gitgulf` exists and is accessible from the workflow.
- The workflow `GITHUB_TOKEN` has permission to **push** to `tychop/homebrew-gitgulf`.
- The `Formula/` directory exists in `homebrew-gitgulf` (the workflow will (over)write `Formula/gitgulf.rb`).

## Testing changes safely

If you change `.github/workflows/release.yml` and want to test without affecting Homebrew:

- Use a temporary tag (e.g. `v0.0.1-test`) on a branch or fork.
- Optionally comment out the "Update Homebrew formula" and "Commit and push" steps in `release.yml` so only builds + GitHub Release run.
- Once the behavior looks good, restore those steps and tag a real version (e.g. `v0.2.0`).
